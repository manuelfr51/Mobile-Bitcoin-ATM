{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load app_extras %}
{% block content %}
<div class="container">
    <!-- Profile Menu -->
    {% with current_tab='credentials' %}
      {% include "merchants/breadcrumb.html" %}
    {% endwith %}
  <div class="col-sm-12 col-xs-12 col-md-9">

      <div class="row">
        <div class="col-sm-12">
          <h4 class="hl">
            <a style="color:#515151;" href="#">{% trans "Bitcoin Wallet" %}</a>
          </h4>

          {% if credential %}

            {% include "merchants/_delete_api_credentials_modal.html" %}
            {% include "merchants/_add_funds_modal.html" %}

            {% trans "Added At" %}: {{credential.created_at|naturaltime}}
            {% trans "Status" %}: {{credential.get_status|format_status_string}}
            {% trans "API Key" %}: {{credential.api_key|obscure_except_ending}}
            {% trans "Balance" %}: {{balance}}
            {% trans "Refresh" %}
            {% trans "Delete" %}
            <a href="javascript: showDisableModal();" id='disable-button'><i class="fa fa-trash-o"></i></a>
            <a class="btn btn-info btn-lg has-spinner" id="fund-wallet-button" onclick="getTopOffAddress({{credential.id}});" style="margin-left: auto; margin-right: auto; display: block;">
              <span class="spinner"><i class="fa fa-spinner fa-spin"></i></span>
              {% trans "Add funds to this wallet" %}
            </a>
            LINK TO DELETE CREDENTIALS

          {% else %}

            <p>
              {% blocktrans %}
                In order to sell bitcoin to customers, you need to link a Bitcoin wallet to your CoinSafe account <a href="#" data-toggle="collapse" data-target="#moreinfo">(learn more)</a>.
              {% endblocktrans %}
            </p>

            <div id="moreinfo" class="collapse">
              <p>
                {% blocktrans %}
                  This wallet will be used to automatically transfer funds to your customers whenever you sell them Bitcoin.
                  If you already have a Blockchain, Coinbase, or Bitstamp wallet, you can link it to your account by adding your API credentials below.
                  We also can automatically create a new Blockchain wallet for you (a good option if you are just giving us a try).
                {% endblocktrans %}
              </p>
              <p>
                {% blocktrans %}
                  No funds will ever be moved from your wallet without your explicit permission, and we take every precaution to secure this sensitive data.
                  That being said, we recommend that all of our users create a separate wallet to use with CoinSafe that holds a smaller amount of funds that they can top off whenever the balance gets low.
                {% endblocktrans %}
              </p>
              <p>
                {% blocktrans %}
                  Our app is and will continue to be free.
                {% endblocktrans %}
              </p>
              <p>
                {% url 'contact' as contact_url %}
                {% blocktrans %}
                  If you have any questions, please don't hesitate to <a href="{{contact_url}}" target="_blank">contact us</a>.
                {% endblocktrans %}
              </p>
            </div>


            <form class="form-horizontal" method="post" action="{% url "credentials.views.base_creds" %}" >
              {% load crispy_forms_tags %}
              {{ add_cred_form|crispy }}
              {% csrf_token %}
              <div class="button-wrapper">
                <button type="submit" class="btn btn-primary btn-lg">{% trans "Complete Registration" %}</button>
              </div>
            </form>

          {% endif %}

        </div>
      </div>
    </div>
    </div>
    </div>
{% endblock content %}

{% block admin_footer %}
  {% include "partials/admin_footer.html" %}
{% endblock admin_footer %}

{% block extra_js %}

     <script>

      {# http://stackoverflow.com/a/1408373/1754586 #}
      String.prototype.supplant = function (o) {
        return this.replace(/{([^{}]*)}/g,
          function (a, b) {
              var r = o[b];
              return typeof r === 'string' || typeof r === 'number' ? r : a;
          }
        );
      };

      var BASE_INSTRUCTIONS = '<div id="api_instructions"><p><a target="_blank" href="{0}">Click here for {1} API instructions</a></p></div>';
      var CB_INSTRUCTIONS = BASE_INSTRUCTIONS.supplant(['{% url "coinbase_instructions" %}', 'Coinbase']);
      var BS_INSTRUCTIONS = BASE_INSTRUCTIONS.supplant(['{% url "bitstamp_instructions" %}', 'Bitstamp']);
      var BCI_INSTRUCTIONS = BASE_INSTRUCTIONS.supplant(['{% url "blockchain_instructions" %}', 'Blockchain']);

      function hideAll() {
        $("#div_id_cb_api_key").addClass("hidden");
        $("#div_id_cb_secret_key").addClass("hidden");

        $("#div_id_bs_api_key").addClass("hidden");
        $("#div_id_bs_secret_key").addClass("hidden");
        $("#div_id_bs_customer_id").addClass("hidden");

        $("#div_id_bci_main_password").addClass("hidden");
        $("#div_id_bci_second_password").addClass("hidden");
        $("#div_id_bci_username").addClass("hidden");

        $('#div_id_btc_address').addClass('hidden');

        $("#api_instructions").remove();
      }

      function selectCoinbase() {
        hideAll();
        $("#div_id_cb_api_key").removeClass("hidden");
        $("#div_id_cb_secret_key").removeClass("hidden");
        $("#div_id_exchange_choice").after(CB_INSTRUCTIONS);
      }

      function selectBitstamp() {
        hideAll();
        $("#div_id_bs_api_key").removeClass("hidden");
        $("#div_id_bs_secret_key").removeClass("hidden");
        $("#div_id_bs_customer_id").removeClass("hidden");
        $("#div_id_exchange_choice").after(BS_INSTRUCTIONS);
      }

      function selectBlockchain() {
        hideAll();
        $("#div_id_bci_main_password").removeClass("hidden");
        $("#div_id_bci_second_password").removeClass("hidden");
        $("#div_id_bci_username").removeClass("hidden");
        $("#div_id_exchange_choice").after(BCI_INSTRUCTIONS);
      }

      $("#id_exchange_choice_1, #id_exchange_choice_2, #id_exchange_choice_3, #id_exchange_choice_4").change(function(){
        var exchange_choice = $('input[name=exchange_choice]:checked').val();
        if (exchange_choice == 'coinbase') {
          selectCoinbase();
        }else if (exchange_choice == 'bitstamp'){
          selectBitstamp();
        }else if (exchange_choice == 'blockchain') {
          selectBlockchain();
        }
      });


    function showDisableModal() {
      $('#delete-credentials-modal').modal();
    }

    function fundWalletModal() {
      $('#add-funds-modal').modal();
    }

    function disableCredentials() {
      $('#disable-loader').removeClass("hidden");
      $('#disable-button').addClass("hidden");
      $.ajax({
          type: 'get',
          url: '/disable-cb-credentials/',
          success: function (data) {
            console.log('SUCESS');
            location.reload(true);
            $('#disable-loader').addClass("hidden");
            $('#disable-button').removeClass("hidden");

          },
          error: function(data) {
            console.log('refreshCredentials Failed');
            $('#disable-loader').addClass("hidden");
            $('#disable-button').removeClass("hidden");

            location.reload(true);
          }
        });
    }

    $(document).ready(function(){
        selectCoinbase();
        var required_asterisk = '<span class="asteriskField">*</span>';
        $('label:not(.requiredField):not(.radio)').append(required_asterisk);
        // blockchain second password not required 
        $('#div_id_bci_second_password .asteriskField').remove();

    });

  </script>
{% endblock extra_js %}
