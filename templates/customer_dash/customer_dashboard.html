{% extends "base.html" %}
{% block content %}
  {% if current_address.user_confirmed_deposit_at %}
    {% if current_address.all_transactions_complete %}
      {% include "customer_dash/_dash_deposit_complete.html" %}
    {% else %}
      {% include "customer_dash/_dash_deposit_confirm.html" %}
    {% endif %}
  {% else %}
    {% include "customer_dash/_dash_no_deposit_confirm.html" %}
  {% endif %}
{% endblock content %}

{% block extra_js %}
  <script>
    var TIMEOUT_LENGTH = 15000;
      var LAST_POLL_TIME = new Date();
      function poll_new_deposits() {
          $.ajax({
              type: 'get',
              url: '/poll-deposits/',
              success: function (data) {
                LAST_POLL_TIME = new Date();
                var time_since = timeSince(LAST_POLL_TIME);
                $('#last-polled').html(time_since);
                var deposits = data['deposits']['txns']
                if(deposits.length == 0){
                  setTimeout(poll_new_deposits,TIMEOUT_LENGTH);
                }else{
                  location.reload(true);
                }
                
              },
              error: function(data) {
                setTimeout(poll_new_deposits,TIMEOUT_LENGTH);
              }
          });
      }

      function poll_new_confirmations() {
          $.ajax({
              type: 'get',
              url: '/poll-deposits/',
              success: function (data) {
                LAST_POLL_TIME = new Date();
                var time_since = timeSince(LAST_POLL_TIME);
                $('#last-polled').html(time_since);
                
                var deposits = data['deposits']
                if(deposits['txns'].length == 0){
                  setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
                }else if(! deposits['all_complete']){
                  // TODO: FIX
                  conf_num = deposits['txns'][0]['forwarding_conf_num']
                  conf_num_text = conf_num + ' confirmations'
                  $('#txn-status').html(conf_num_text);
                  setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
                }else{
                  location.reload(true);
                }
                
              },
              error: function(data) {
                setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
              }
          });
      }

      function set_time_since() {
        var time_since = timeSince(LAST_POLL_TIME);
        var time_since_text = "Last updated: "+time_since+" ago";
        $('#last-polled').html(time_since_text);
        {% if not transaction %}
          setTimeout(set_time_since,1000);
        {% else %}
          {% if not transaction.irreversible_by %}
            setTimeout(set_time_since,1000);
          {% endif %}
        {% endif %}
      }

    function getNextAddress() {
      $("#show-address-button").toggleClass("active");
      $.ajax({
          type: 'get',
          url: '/get-deposit-address/',
          success: function (data) {
            $("#show-address-button").toggleClass("active");
            var address = data['address'];
            if (address){
              $('#deposit-address-modal').modal();
              $("#current_address").html(address);
              var src="//chart.googleapis.com/chart?cht=qr&chl=bitcoin%3A"+address+"&choe=UTF-8&chs=275x275";
              $("#qr_code").attr("src", src);

              $("#qr_code_span").slideDown(500);
            }
          },
          error: function(data) {
            $("#show-address-button").toggleClass("active");
            console.log('FAILURE');
          }
        });
    }

    function confirmAddressDeposit() {
      $.ajax({
          type: 'get',
          url: '/confirm-deposit/',
          success: function (data) {
            location.reload(true);
          },
          error: function(data) {
            console.log('FAILURE');
          }
        });
    }

    function getBtcPrice() {
      $("#fiat-amt-loader").toggleClass("show hidden");
      $.ajax({
        type: 'get',
        url: '/get-bitcoin-price/',
        success: function (data) {
          $("#fiat-amt-loader").toggleClass("show hidden");
          var amount = "BTC Price: "+data['amount']+" "+data['currency_code']+" ("+data['markup']+"% markup)"
          // $("#fiat-amt").toggleClass("show hidden");
          $("#fiat-amt").text(amount);
        },
        error: function(data) {
          $("#fiat-amt-loader").toggleClass("show hidden");
        }
      });

    }
  
    function completeTransaction() {
      $("#complete-transaction-button").toggleClass("active");
      $.ajax({
          type: 'get',
          url: '/complete-deposit/',
          success: function (data) {
            $("#complete-transaction-button").toggleClass("active");
            location.reload(true);
          },
          error: function(data) {
            $("#complete-transaction-button").toggleClass("active");
            console.log('FAILURE');
          }
        });
    }

    function cancelAddress() {
      $.ajax({
          type: 'get',
          url: '/cancel-address/',
          success: function (data) {
            location.reload(true);
          },
          error: function(data) {
            console.log('FAILURE');
            // location.reload(true);
          }
        });

    }

    $(document).ready(function(){
      {% if current_address.user_confirmed_deposit_at %}
        {% if not transactions %}
            setTimeout(
            function() 
            {
              poll_new_deposits();
            }, 15000);

            setTimeout(
            function() 
            {
              set_time_since();
            }, 1000);

          {% else %}
            {% if not current_address.all_transactions_complete %}
              setTimeout(
              function() 
              {
                poll_new_confirmations();
              }, 15000);

              setTimeout(
              function() 
              {
                set_time_since();
              }, 1000);
          {% endif %}
        {% endif %}

      {% else %}
        getBtcPrice();
        // setTimeout(
        //   function() 
        //   {
        //     getBtcPrice();
        //   }, 15000);

      {% endif %}
        // setTimeout(
        //   function() 
        //   {
        //     poll_deposits();
        //   }, 5000);
    });    
  </script>
{% endblock %}
