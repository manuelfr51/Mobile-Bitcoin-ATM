{% extends "base.html" %}
{% block content %}
  {% if transactions or current_address.customer_confirmed_deposit_at %}
    {% if current_address.all_transactions_complete and shopper %}
      {% include "customer_dash/_deposit_complete.html" %}
    {% else %}
      {% include "customer_dash/_deposit_confirm.html" %}
    {% endif %}
  {% else %}
    {% include "customer_dash/_no_deposit_confirm.html" %}
  {% endif %}
{% endblock content %}

{% block extra_js %}
  <script>
      var TIMEOUT_LENGTH = 5000;
      var LAST_POLL_TIME = new Date();

      function poll_new_deposits() {
          $.ajax({
              type: 'get',
              url: '/poll-deposits/',
              success: function (data) {
                LAST_POLL_TIME = new Date();
                var time_since = timeSince(LAST_POLL_TIME);
                $('#last-polled-time').html(time_since);
                var deposits = data['deposits']['txns']
                if(deposits.length == 0){
                  setTimeout(poll_new_deposits,TIMEOUT_LENGTH);
                }else{
                  location.reload(true);
                }
              },
              error: function(data) {
                setTimeout(poll_new_deposits,TIMEOUT_LENGTH*10);
              }
          });
      }

      function poll_new_confirmations() {
          $.ajax({
              type: 'get',
              url: '/poll-deposits/',
              success: function (data) {
                LAST_POLL_TIME = new Date();
                var time_since = timeSince(LAST_POLL_TIME);
                $('#last-polled-time').html(time_since);
                var deposits = data['deposits']
                if(deposits['txns'].length == 0){
                  setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
                }else if(! deposits['all_complete']){
                  var confs_needed = data['confs_needed'];
                  var txns = deposits['txns'];
                  var txns_length = txns.length;
                  for (var i = 0; i < txns_length; i++) {
                    var txn = txns[i];
                    var conf_num = txn['forwarding_conf_num']
                    var txn_hash = txn['forwarding_txn_hash']
                    var conf_num_text = 'Pending ('+conf_num+' of '+confs_needed+' Confirms Needed)';
                    $('#tx-status-'+txn_hash).html(conf_num_text);
                  }
                  setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
                }else{
                  location.reload(true);
                }
              },
              error: function(data) {
                setTimeout(poll_new_confirmations,TIMEOUT_LENGTH);
              }
          });
      }

      function set_time_since() {
        var time_since = timeSince(LAST_POLL_TIME);
        $('#last-polled-time').html(time_since);
        {% if not transaction %}
          setTimeout(set_time_since,1000);
        {% elif not transaction.irreversible_by %}
          setTimeout(set_time_since,1000);
        {% endif %}
      }

    function getNextAddress() {
      $("#show-address-button").toggleClass("active");
      $.ajax({
          type: 'get',
          url: '/get-deposit-address/',
          success: function (data) {
            $("#show-address-button").toggleClass("active");
            var address = data['address'];
            if (address){
              $('#deposit-address-modal').modal();
              $("#current_address").html(address);
              var src="//chart.googleapis.com/chart?cht=qr&chl=bitcoin%3A"+address+"&choe=UTF-8&chs=275x275";
              $("#qr_code").attr("src", src);

              $("#qr_code_span").slideDown(500);
            }
          },
          error: function(data) {
            $("#show-address-button").toggleClass("active");
            console.log('getNextAddress Failed');
          }
        });
    }

    function buyBitcoinModal() {
      $('#buy-bitcoin-modal').modal();
      
    }

    function confirmAddressDeposit() {
      $.ajax({
          type: 'get',
          url: '/customer-confirm-deposit/',
          success: function (data) {
            location.reload(true);
          },
          error: function(data) {
            console.log('confirmAddressDeposit Failed');
          }
        });
    }

    var BTC_PRICE_TIMEOUT_MS = 10000;
    function getBtcPrice() {
      $.ajax({
        type: 'get',
        url: '/get-bitcoin-price/',
        success: function (data) {
          $("#fiat-amt-loader").addClass("hidden");
          $("#pricing-info").removeClass("hidden");
          $("#fiat-amt").text(data['buy_amount']);
          $("#currency-code").text(data['currency_code']);
          $("#markup").text(data['markup']);

          BTC_PRICE_TIMEOUT_MS *= 1.3;
          setTimeout(getBtcPrice,BTC_PRICE_TIMEOUT_MS);
        },
        error: function(data) {
          console.log('getBtcPrice Failed');
          setTimeout(getBtcPrice, 30000);
        }
      });

    }

    function completeTransaction() {
      $("#complete-transaction-button").toggleClass("active");
      $.ajax({
          type: 'get',
          url: '/merchant-complete-deposit/',
          success: function (data) {
            $("#complete-transaction-button").toggleClass("active");
            location.reload(true);
          },
          error: function(data) {
            $("#complete-transaction-button").toggleClass("active");
            console.log('completeTransaction Failed');
          }
        });
    }

    function cancelAddress() {
      $.ajax({
          type: 'get',
          url: '/cancel-address/',
          success: function (data) {
            location.reload(true);
          },
          error: function(data) {
            console.log('cancelAddress Failed');
            // location.reload(true);
          }
        });
    }
    $("#id_fiat_amount").blur(function(){
      $("#btc-amount").addClass("hidden");
      $("#btc-amt-loader").removeClass("hidden");
      $.ajax({
        type: 'get',
        url: '/get-bitcoin-price/',
        success: function (data) {
          $("#btc-amount").removeClass("hidden");
          $("#btc-amt-loader").addClass("hidden");
          var entered_amount = $('#id_fiat_amount').val();
          var final_btc = parseFloat(entered_amount) / data['sell_amount'];
          
          $("#btc-amount").html('â‰ˆ <i class="fa fa-bitcoin"></i>'+final_btc.toFixed(4));
        },
        error: function(data) {
          $("#btc-amount").removeClass("hidden");
          $("#btc-amt-loader").addClass("hidden");
          // setTimeout(getBtcPrice, 30000);
        }
      });
      
    });

    $(document).ready(function(){
      {% if transactions or current_address.customer_confirmed_deposit_at %}

        {% if transactions %}

          {% if not current_address.all_transactions_complete %}
            setTimeout(
            function() {
              poll_new_confirmations();
            }, 15000);

            setTimeout(
            function() {
              set_time_since();
            }, 1000);
          {% endif %}

        {% else %}

          setTimeout(
          function() {
            poll_new_deposits();
          }, 15000);

          setTimeout(
          function() {
            set_time_since();
          }, 1000);
        {% endif %}

      {% else %}

        getBtcPrice();

        {% if not transactions %}
          poll_new_deposits()
        {% endif %}
      {% endif %}
    });
  </script>
{% endblock %}
